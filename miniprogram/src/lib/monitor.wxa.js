/**
 * Copyright (C) 2019 SFTC. All rights reserved.
 * Version 0.1.1
 */

"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))),o.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var r,o,n={},i=Object.keys(t);for(o=0;o<i.length;o++)r=i[o],0<=e.indexOf(r)||(n[r]=t[r]);return n}function _objectWithoutProperties(t,e){if(null==t)return{};var r,o,n=_objectWithoutPropertiesLoose(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(o=0;o<i.length;o++)r=i[o],0<=e.indexOf(r)||Object.prototype.propertyIsEnumerable.call(t,r)&&(n[r]=t[r])}return n}var parser=function(t){var e=t.split("\n");return e[0].indexOf("thirdScriptError")<0?{err_stack:t}:{err_msg:e[1].split(";")[0],err_location:e[1].split(";")[1],err_stack:t}},api="https://monitoric.sf-express.com/api/monitor/adderror",DEFAULT_RequestInterceptor=function(t){return!(t.statusCode<200||300<=t.statusCode)},Monitor=function(){function o(t){var e=t.appid,r=t.platform;if(_classCallCheck(this,o),!e)throw new Error("Monitor: appid can not be empty");if(!r)throw new Error("Monitor: platform can not be empty");this.appid=e,this.platform=r,this.systemInfo={},this.request=wx.request,this.onError=this.onError.bind(this)}return _createClass(o,[{key:"onError",value:function(t){var e=parser(t);this.report(_objectSpread({},e,{type:"script"}))}},{key:"init",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:DEFAULT_RequestInterceptor;this.getSystemInfo(),this.hookRequest(t)}},{key:"hookRequest",value:function(p){var u=this;Object.defineProperty(wx,"request",{configurable:!0,enumerable:!0,writable:!0,value:function(){var e=(arguments.length<=0?void 0:arguments[0])||{},r=e.success,o=e.fail,n=e.url,t=e.method,i=void 0===t?"GET":t,s=e.data,a=Object.assign(e,{success:function(t){r&&r.call(this,t),p(t,e)||u.report({api_status:t.statusCode,api_url:n,api_data:JSON.stringify(s),api_response:"string"==typeof t.data?t.data:JSON.stringify(t.data),api_method:i,type:"api"})},fail:function(t){o&&o.call(this,t),u.report({api_status:null,api_url:n,api_data:JSON.stringify(s),api_method:i,api_error:t,type:"api"})}});return u.request.apply(this,[a])}})}},{key:"report",value:function(t){this.systemInfo&&"devtools"===this.systemInfo.platform||this.request({url:api,method:"POST",data:_objectSpread({},t,{system_info:this.systemInfo,appid:this.appid,platform_id:this.platform,date:Date.now()})})}},{key:"getSystemInfo",value:function(){var r=this;wx.getSystemInfo({success:function(t){t.errMsg;var e=_objectWithoutProperties(t,["errMsg"]);r.systemInfo=e}})}}]),o}();module.exports=Monitor;
